@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.PaginationConfig
@import models.PageOfSubmissions
@import models.declaration.submissions.RequestType.SubmissionRequest
@import models.declaration.submissions.Submission
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.dashboard.DashboardHelper.Page
@import views.helpers.{EnhancedStatusHelper, ViewDates}
@import views.html.components.gds._

@import java.time.ZoneId

@this(govukTable: GovukTable, link: link, pagination: pagination, paginationConfig: PaginationConfig)

@(label: String, pageOfSubmissions: PageOfSubmissions, baseHref: String)(implicit request: Request[_], messages: Messages)

@mrnLink(submission: Submission) = @{
  HtmlContent(
      link(
          text = submission.mrn.getOrElse(messages("submissions.declarationDetails.mrn.pending")),
          call = routes.DeclarationDetailsController.displayPage(submission.uuid),
          textHidden = Some(messages("submissions.hidden.text", submission.ducr.getOrElse("")))
      )
  )
}

@timestamp(submission: Submission) = @{
  submission.actions
    .find(_.requestType == SubmissionRequest)
    .map(_.requestTimestamp.withZoneSameInstant(ZoneId.of("Europe/London")))
    .map(ViewDates.formatDateAtTime)
    .getOrElse("")
}

@headCells = @{
  Some(List("mrn","ducr","lrn","dateAndTime","status").map(key => HeadCell(content = Text(messages(s"submissions.$key.header")))))
}

@paginationComponent = @{
  val totalPagesInGroup = Math.ceil(pageOfSubmissions.totalSubmissionsInGroup.toDouble / paginationConfig.itemsPerPage).toInt
  val currentPage = request.getQueryString(Page).fold(totalPagesInGroup)(_.toInt)

  pagination(pageOfSubmissions, baseHref, totalPagesInGroup, currentPage)
}

@if(pageOfSubmissions.submissions.nonEmpty) {
    <p id="@{s"${label}-content-hint"}" class="govuk-body">@Html(messages(s"submissions.${label}.content.hint", <br/>))</p>

    @govukTable(Table(
        head = headCells,
        rows = pageOfSubmissions.submissions.map { submission =>
            Seq(
                TableRow(content = mrnLink(submission), classes = "govuk-table__cell_break-all"),
                TableRow(content = Text(submission.ducr.getOrElse("")), classes = "govuk-table__cell_break-all"),
                TableRow(content = Text(submission.lrn), classes = "govuk-table__cell_break-all"),
                TableRow(content = Text(timestamp(submission))),
                TableRow(content = Text(EnhancedStatusHelper.asText(submission)))
            )
        }
    ))
}

<div class="govuk-grid-row">
    @if(pageOfSubmissions.submissions.nonEmpty) {
        @paginationComponent
    } else {
        <div class="ceds-pagination__summary">
            <p class="govuk-body">@{messages("submissions.empty.tab")}</p>
        </div>
    }
</div>
