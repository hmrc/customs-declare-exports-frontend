@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import controllers.declaration.routes
@import controllers.navigation.Navigator
@import models.declaration.ExportItem
@import models.requests.JourneyRequest
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.{BackButton, Title}
@import views.html.components.gds._
@import views.components.gds.Styles._
@import play.twirl.api.HtmlFormat
@import scala.collection.immutable

@this(govukLayout: gdsMainTemplate,
        govukFieldset: GovukFieldset,
        govukButton: GovukButton,
        govukRadios: GovukRadios,
        govukTable : GovukTable,
        errorSummary: errorSummary,
        sectionHeader: sectionHeader,
        exportsInputText: exportsInputText,
        tariffDetails: tariffDetails,
        saveAndContinue: saveAndContinue,
        addButton: addButton,
        removeButton: removeButton,
        formHelper: uk.gov.hmrc.play.views.html.helpers.FormWithCSRF)

@(mode: Mode, items: List[ExportItem], itemsErrors: Seq[FormError] = Seq.empty)(implicit request: JourneyRequest[_], messages: Messages)

@titleMessage = @{
    if(items.isEmpty) { messages("supplementary.itemsAdd.title") }
    else { messages("supplementary.itemsAdd.titleWithItems", items.length) }
}

@pageHint = {
    <span class="govuk-hint">
        @messages("supplementary.itemsAdd.title.hint")
    </span>
}

@addButtonMessage = @{
    if(items.isEmpty) { messages("site.add.item") }
    else { messages("site.add.anotherItem") }
}

@itemsSaveButtons(items: List[ExportItem]) = {
    @if(items.nonEmpty) {
        @saveAndContinue("site.save_and_continue")
    }
    <p class="govuk-body">
        @saveAsDraft("site.save_and_come_back_later")
    </p>
}

@changeLink(item: ExportItem) = {
    <a class="govuk-link" href="@routes.ProcedureCodesController.displayPage(mode, item.id).url">
        @messages("site.change")
        <span class="govuk-visually-hidden">
            @messages("supplementary.itemsAdd.change.hint", item.sequenceId)
        </span>
    </a>
}

@noOfPackagesSection(item: ExportItem) = {
    @item.packageInformation.map { packageInformationList =>
        @if(packageInformationList.drop(1).isEmpty) {
            @packageInformationList.map { packageInfo =>
                @packageInfo.numberOfPackages.getOrElse("")
            }
        } else {
            <ol>
                @packageInformationList.map { packageInfo =>
                    @packageInfo.numberOfPackages.map( packages =>
                        <li>{packages}</li>
                    )
                }
            </ol>
        }
    }
}

@itemsTable = {
    @if(items.nonEmpty) {
        @govukTable(Table(
            attributes = Map("id" -> "item_table"),
            head = Some(Seq(
                HeadCell(content = Text(messages("supplementary.itemsSummary.itemNumber"))),
                HeadCell(content = Text(messages("supplementary.itemsSummary.procedureCode"))),
                HeadCell(content = Text(messages("supplementary.itemsSummary.commodityCode"))),
                HeadCell(content = Text(messages("supplementary.itemsSummary.noOfPackages"))),
                HeadCell(colspan = Some(2))
            )),
            rows = items.zipWithIndex.map { case (item, index) =>
                Seq(
                    TableRow(
                        content = Text(item.sequenceId.toString),
                        attributes = Map("id" -> s"item_$index--sequence_id")
                    ),
                    TableRow(
                        content = Text(item.procedureCodes.flatMap(_.procedureCode).getOrElse("")),
                        attributes = Map("id" -> s"item_$index--procedure_code")
                    ),
                    TableRow(
                        content = Text(item.commodityDetails.flatMap(_.combinedNomenclatureCode).getOrElse("")),
                        attributes = Map("id" -> s"item_$index--item_type")
                    ),
                    TableRow(
                        content = HtmlContent(noOfPackagesSection(item).toString),
                        attributes = Map("id" -> s"item_$index--package_count")
                    ),
                    TableRow(
                        content = HtmlContent(changeLink(item).toString()),
                        attributes = Map("id" -> s"item_$index--change")
                    ),
                    TableRow(
                        content = HtmlContent(removeButton(
                            href = Some(routes.ItemsSummaryController.removeItem(mode, item.id).url),
                            hiddenLabel = Some(messages("supplementary.itemsAdd.remove.hint", item.sequenceId))
                        )),
                        attributes = Map("id" -> s"item_$index--remove")
                    )
                )
            }
        ))
    }
}

@govukLayout(
    title = Title(titleMessage, "supplementary.items"),
    backButton = Some(BackButton(messages("site.back"), Navigator.backLink(ExportItem, mode)))) {

    @formHelper(action = routes.ItemsSummaryController.submit(mode), 'autoComplete -> "off") {

        @errorSummary(itemsErrors)

        @sectionHeader(messages("supplementary.items"))
        @govukFieldset(Fieldset(
            legend = Some(Legend(
                content = Text(messages(titleMessage)),
                classes = gdsPageLegend,
                isPageHeading = true
            )),
            html = HtmlFormat.fill(immutable.Seq(
                pageHint,
                itemsTable,
                addButton(label = addButtonMessage, hiddenLabel = Some(addButtonMessage)),
                itemsSaveButtons(items)
            ))
        ))
    }
}


