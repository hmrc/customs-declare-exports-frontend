@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import controllers.declaration.routes.{SubmissionController, SummaryController}
@import controllers.routes.RejectedNotificationsController
@import models.declaration.submissions.EnhancedStatus.ERRORS
@import models.requests.JourneyRequest
@import views.helpers.{BackButton, Title}
@import views.helpers.summary._
@import views.html.components.gds._
@import views.html.declaration.summary.sections._
@import uk.gov.hmrc.govukfrontend.views.html.components._

@this(
    govukLayout: gdsMainTemplate,
    govukWarningText: GovukWarningText,
    govukButton: GovukButton,
    pageTitle: pageTitle,
    card1ForReferences: Card1ForReferences,
    card2ForParties: Card2ForParties,
    card3ForRouteOfGoods: Card3ForRouteOfGoods,
    card4ForLocations: Card4ForLocations,
    card5ForTransactions: Card5ForTransactions,
    card7ForTransport: Card7ForTransport,
    items_section: items_section,
    errorSummary: errorSummary,
    linkButton: linkButton,
    exitAndCompleteLater: exitAndCompleteLater,
    paragraphBody: paragraphBody
)

@(backLink: Call,
  errors: Seq[FormError] = Seq.empty[FormError],
  maybeContinuePlaceholder: Option[String] = None
)(implicit request: JourneyRequest[_], messages: Messages, appConfig: AppConfig)

@draftContinueLink = { @if(request.cacheModel.declarationMeta.readyForSubmission != Some(true)) {
    @maybeContinuePlaceholder.map { continuePlaceholder =>
        @govukButton(Button(
            content = Text(messages("site.continue")),
            classes = "govuk-!-margin-top-4",
            href = Some(continuePlaceholder),
            attributes = Map("id" -> continuePlaceholder)
        ))
    }
    }
}

@continueLink = @{
    request.cacheModel.declarationMeta.readyForSubmission match {
        case Some(true) if errors.isEmpty =>
            linkButton("site.confirm_and_continue", SubmissionController.displaySubmitDeclarationPage)

        case Some(true) => linkButton("site.confirm_and_continue", SummaryController.displayPage)
        case _          =>
    }
}

@viewDeclarationErrors = @{
    val declaration = request.cacheModel
    if(declaration.declarationMeta.parentDeclarationEnhancedStatus == Some(ERRORS)) {
        declaration.declarationMeta.parentDeclarationId.map { parentId =>
          linkButton(
            "site.view.declaration.errors",
            RejectedNotificationsController.displayPage(parentId),
            "govuk-button govuk-button--secondary"
          )
        }
    }
}

@titleKey = @{
    if(request.cacheModel.declarationMeta.parentDeclarationEnhancedStatus == Some(ERRORS))
        "declaration.summary.amend-header"
    else if(request.cacheModel.declarationMeta.readyForSubmission == Some(true))
        "declaration.summary.normal-header"
    else "declaration.summary.saved-header"
}

@draftBodyText = @{
    if(request.cacheModel.declarationMeta.readyForSubmission != Some(true))
        paragraphBody(messages("declaration.summary.draft.body"))
}

@govukLayout(
    title = Title(titleKey),
    backButton = Some(BackButton(messages("site.backToDeclarations"), backLink)),
    useCustomContentWidth = true,
    showDeclarationSummaryLink = false
) {

    @pageTitle(messages(titleKey))

    @errorSummary(errors)

    @govukWarningText(WarningText(
        iconFallbackText = Some(messages("site.warning")),
        content = Text(messages("declaration.summary.warning"))
    ))

    @draftBodyText

    @card1ForReferences.eval(request.cacheModel)

    @card2ForParties.eval(request.cacheModel)

    @card3ForRouteOfGoods.eval(request.cacheModel)

    @card4ForLocations.eval(request.cacheModel)

    @card5ForTransactions.eval(request.cacheModel)

    @items_section(request.cacheModel)

    @card7ForTransport.eval(request.cacheModel)

    <div class="govuk-button-group govuk-!-margin-top-9">
        @draftContinueLink
        @continueLink
        @viewDeclarationErrors
    </div>

    <p class="govuk-body">
        @exitAndCompleteLater()
    </p>
    <br/>
}