@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import controllers.declaration.routes
@import models.declaration.ExportItem
@import models.DeclarationType.{DeclarationType, STANDARD, SUPPLEMENTARY}
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.helpers.ActionItemBuilder.actionSummaryItem
@import views.html.components.elements_in_separate_lines
@import views.html.components.gds.{linkContent, summary_list}
@import views.html.declaration.summary._
@import views.helpers.Link

@this(
    summaryList: summary_list,
    linkContent: linkContent,
    package_information: package_information,
    union_and_national_codes: union_and_national_codes,
    additional_documents: additional_documents
)

@(item: ExportItem, itemIdx: Int, declarationType: DeclarationType, actionsEnabled: Boolean = true)(implicit messages: Messages)

@actions(action: => Actions) = @{ if(actionsEnabled) Some(action) else None }

@headerAction = @{
    if(actionsEnabled) Some(Link(messages("declaration.summary.items.item.headerAction"), routes.ItemsSummaryController.displayRemoveItemConfirmationPage(item.id, true)))
    else None
}

@itemDisplayNum = @{ itemIdx + 1 }

@summaryList(
    id = s"declaration-items-summary-$itemDisplayNum",
    heading = Some(messages("declaration.summary.items.item.presentationId", itemDisplayNum)),
    headerAction = headerAction,
    summaryListRows = Seq(
        item.procedureCodes.flatMap(_.procedureCode).map(data =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-procedureCode-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.procedureCode"))
                ),
                value = Value(
                    content = Text(data)
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.ProcedureCodesController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.procedureCode.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.procedureCodes.map(data =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-additionalProcedureCodes-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.additionalProcedureCodes"))
                ),
                value = Value(
                    content = Text(data.additionalProcedureCodes.mkString(" "))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.AdditionalProcedureCodesController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.additionalProcedureCodes.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.fiscalInformation.map(fiscalInformation =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-onwardSupplyRelief-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.onwardSupplyRelief"))
                ),
                value = Value(
                    content = Text(fiscalInformation.onwardSupplyRelief)
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.FiscalInformationController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.onwardSupplyRelief.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.additionalFiscalReferencesData.map(additionalFiscalReferences =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-VATdetails-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.VATdetails"))
                ),
                value = Value(HtmlContent(elements_in_separate_lines(additionalFiscalReferences.references.map(_.asString)))),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.AdditionalFiscalReferencesController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.VATdetails.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.commodityDetails.map(commodityDetails =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-commodityCode-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.commodityCode"))
                ),
                value = Value(
                    content = Text(commodityDetails.combinedNomenclatureCode.getOrElse(""))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.CommodityDetailsController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.commodityCode.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.commodityDetails.map(commodityDetails =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-goodsDescription-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.goodsDescription"))
                ),
                value = Value(
                    content = Text(commodityDetails.descriptionOfGoods.getOrElse(""))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.CommodityDetailsController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.goodsDescription.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.dangerousGoodsCode.map(dangerousGoodsCode =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-unDangerousGoodsCode-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.unDangerousGoodsCode"))
                ),
                value = Value(
                    content = Text(dangerousGoodsCode.dangerousGoodsCode.getOrElse(messages("site.no")))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.UNDangerousGoodsCodeController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.unDangerousGoodsCode.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.cusCode.map(cusCode =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-cusCode-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.cusCode"))
                ),
                value = Value(
                    content = Text(cusCode.cusCode.getOrElse(messages("site.no")))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.CusCodeController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.cusCode.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.taricCodes.map(taricCodes =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-taricAdditionalCodes-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.taricAdditionalCodes"))
                ),
                value = Value(
                    content = Text(if(taricCodes.isEmpty) messages("site.no") else taricCodes.map(_.taricCode).mkString(", "))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.TaricCodeSummaryController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.taricAdditionalCodes.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.nactCodes.map(nactCodes =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-nationalAdditionalCodes-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.nationalAdditionalCodes"))
                ),
                value = Value(
                    content = Text(if(nactCodes.isEmpty) messages("site.no") else nactCodes.map(_.nactCode).mkString(", "))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.NactCodeSummaryController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.nationalAdditionalCodes.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.nactExemptionCode.map( nactCode =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-zeroRatedForVat-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.zeroRatedForVat"))
                ),
                value = Value(
                    content = Text(messages(s"declaration.summary.items.item.zeroRatedForVat.${nactCode.nactCode}"))
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.ZeroRatedForVatController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.zeroRatedForVat.change", itemDisplayNum))
                        )
                    )
                ))
            )
        ),
        item.statisticalValue.map(statisticalValue =>
            SummaryListRow(
                classes = s"item-${itemDisplayNum}-itemValue-row",
                key = Key(
                    content = Text(messages("declaration.summary.items.item.itemValue"))
                ),
                value = Value(
                    content = Text(statisticalValue.statisticalValue)
                ),
                actions = actions(Actions(
                    items = Seq(
                        actionSummaryItem(
                            href = routes.StatisticalValueController.displayPage(item.id).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.items.item.itemValue.change", itemDisplayNum))
                        )
                    )
                ))
            )
        )
    ),
    classes = "govuk-!-margin-bottom-2"
)

@item.packageInformation.map(packageInformation =>
    package_information(item.id, itemDisplayNum, packageInformation, actionsEnabled)
)

@summaryList("", None, None, Seq(
    item.commodityMeasure.map(commodityMeasure =>
        SummaryListRow(
            classes = s"item-${itemDisplayNum}-grossWeight-row",
            key = Key(
                content = Text(messages("declaration.summary.items.item.grossWeight"))
            ),
            value = Value(
                content = Text(commodityMeasure.grossMass.getOrElse(""))
            ),
            actions = actions(Actions(
                items = Seq(
                    actionSummaryItem(
                        href = routes.CommodityMeasureController.displayPage(item.id).url,
                        content = HtmlContent(linkContent(messages("site.change"))),
                        visuallyHiddenText = Some(messages("declaration.summary.items.item.grossWeight.change", itemDisplayNum))
                    )
                )
            ))
        )
    ),
    item.commodityMeasure.map(commodityMeasure =>
        SummaryListRow(
            classes = s"item-${itemDisplayNum}-netWeight-row",
            key = Key(
                content = Text(messages("declaration.summary.items.item.netWeight"))
            ),
            value = Value(
                content = Text(commodityMeasure.netMass.getOrElse(""))
            ),
            actions = actions(Actions(
                items = Seq(
                    actionSummaryItem(
                        href = routes.CommodityMeasureController.displayPage(item.id).url,
                        content = HtmlContent(linkContent(messages("site.change"))),
                        visuallyHiddenText = Some(messages("declaration.summary.items.item.netWeight.change", itemDisplayNum))
                    )
                )
            ))
        )
    ),
    if (List(STANDARD, SUPPLEMENTARY).contains(declarationType))
        item.commodityMeasure.flatMap(commodityMeasure =>
            commodityMeasure.supplementaryUnits.map(supplementaryUnits =>
                SummaryListRow(
                    classes = s"item-${itemDisplayNum}-supplementaryUnits-row",
                    key = Key(
                        content = Text(messages("declaration.summary.items.item.supplementaryUnits"))
                    ),
                    value = Value(
                        content = Text(supplementaryUnits)
                    ),
                    actions = actions(Actions(
                        items = Seq(
                            actionSummaryItem(
                                href = routes.SupplementaryUnitsController.displayPage(item.id).url,
                                content = HtmlContent(linkContent(messages("site.change"))),
                                visuallyHiddenText = Some(messages("declaration.summary.items.item.supplementaryUnits.change", itemDisplayNum))
                            )
                        )
                    ))
                )
           )
        )
    else None
),
    classes = "govuk-!-margin-bottom-3"
)

@item.additionalInformation.map(additionalInformation =>
    union_and_national_codes(item.id, itemDisplayNum, additionalInformation.items, actionsEnabled)
)

@additional_documents(item, actionsEnabled)
