@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import controllers.declaration.routes.{NatureOfTransactionController, InvoiceAndExchangeRateController, TotalPackageQuantityController, InvoiceAndExchangeRateChoiceController}
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.components.gds.ActionItemBuilder.actionItem
@import views.html.components.gds.{linkContent, summary_list}
@import views.html.declaration.summary.related_documents
@import models.DeclarationType._

@this(
    summaryList: summary_list,
    linkContent: linkContent,
    related_documents: related_documents
)

@(mode: Mode, declaration: ExportsDeclaration, actionsEnabled: Boolean = true)(implicit messages: Messages)

@hasTransactionData = @{
   declaration.totalNumberOfItems.isDefined || declaration.natureOfTransaction.isDefined || declaration.previousDocuments.isDefined
}

@totalAmountInvoicedRowContent = @{
    val currencyCode = declaration.totalNumberOfItems.flatMap(_.totalAmountInvoicedCurrency).getOrElse("")
    val totalAmountInvoiced = declaration.totalNumberOfItems.flatMap(_.totalAmountInvoiced).getOrElse("")
    if (declaration.isInvoiceAmountLessThan100000) messages("declaration.totalAmountInvoiced.value.lessThan100000")
    else s"$currencyCode $totalAmountInvoiced"
}

@totalAmountInvoicedActionItemUrl = @{
    if (declaration.isInvoiceAmountLessThan100000) InvoiceAndExchangeRateChoiceController.displayPage(mode).url
    else InvoiceAndExchangeRateController.displayPage(mode).url
}

@totalAmountInvoicedRow = @{
    if (declaration.isType(STANDARD) || declaration.isType(SUPPLEMENTARY))
        Some(SummaryListRow(
            classes = "item-amount-row",
            key = Key(
                content = Text(messages("declaration.summary.transaction.itemAmount"))
            ),
            value = Value(
                content = Text({
                    totalAmountInvoicedRowContent
                })
            ),
            actions = actions(Actions(
                items = List(
                    actionItem(
                        href = totalAmountInvoicedActionItemUrl,
                        content = HtmlContent(linkContent(messages("site.change"))),
                        visuallyHiddenText = Some(messages("declaration.summary.transaction.itemAmount.change"))
                    )
                )
            ))
        ))
    else None
}

@actions(action: Actions) = @{ if (actionsEnabled) Some(action) else None }

@if(hasTransactionData) {
    @summaryList("declaration-transaction-summary", Some(messages("declaration.summary.transaction")), List(
        totalAmountInvoicedRow,
        declaration.totalNumberOfItems.flatMap { _.exchangeRate.map { exchangeRate =>
            SummaryListRow(
                classes = "exchange-rate-row",
                key = Key(
                    content = Text(messages("declaration.summary.transaction.exchangeRate"))
                ),
                value = Value(
                    content = Text(exchangeRate)
                ),
                actions = actions(Actions(
                    items = List(
                        actionItem(
                            href = InvoiceAndExchangeRateController.displayPage(mode).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.transaction.exchangeRate.change"))
                        )
                    )
                ))
            )
        }},
        declaration.totalNumberOfItems.flatMap(_.totalPackage.map { totalPackage =>
            SummaryListRow(
                classes = "total-no-of-packages-row",
                key = Key(
                    content = Text(messages("declaration.summary.transaction.totalNoOfPackages"))
                ),
                value = Value(
                    content = Text(totalPackage)
                ),
                actions = actions(Actions(
                    items = List(
                        actionItem(
                            href = TotalPackageQuantityController.displayPage(mode).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.transaction.totalNoOfPackages.change"))
                        )
                    )
                ))
           )
        }),
        declaration.natureOfTransaction.map { natureOfTransaction =>
            SummaryListRow(
                classes = "nature-of-transaction-row",
                key = Key(
                    content = Text(messages("declaration.summary.transaction.natureOfTransaction"))
                ),
                value = Value(
                    content = Text(messages(s"declaration.summary.transaction.natureOfTransaction.${natureOfTransaction.natureType}"))
                ),
                actions = actions(Actions(
                    items = List(
                        actionItem(
                            href = NatureOfTransactionController.displayPage(mode).url,
                            content = HtmlContent(linkContent(messages("site.change"))),
                            visuallyHiddenText = Some(messages("declaration.summary.transaction.natureOfTransaction.change"))
                        )
                    )
                ))
           )
        }
    ),
        classes = "govuk-!-margin-bottom-3"
    )

    @declaration.previousDocuments.map(previousDocuments =>
        related_documents(mode, previousDocuments.documents, actionsEnabled)
    )
}

