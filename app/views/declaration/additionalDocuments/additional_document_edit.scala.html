@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import forms.declaration.CommodityDetails
@import forms.declaration.additionaldocuments.DocumentWriteOff._
@import forms.declaration.additionaldocuments.AdditionalDocument
@import forms.declaration.additionaldocuments.AdditionalDocument._
@import models.requests.JourneyRequest
@import play.twirl.api.HtmlFormat
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.components.gds.Styles._
@import views.helpers.{AdditionalDocument => AdditionalDocHelper}
@import views.helpers.CommodityCodeHelper.commodityCodeOfItem
@import views.html.components.gds._

@this(
    govukFieldset: GovukFieldset,
    govukInput: GovukInput,
    govukDetails : GovukDetails,
    govukHint: GovukHint,
    errorSummary: errorSummary,
    formGroupWrapper: formGroupWrapper,
    sectionHeader: sectionHeader,
    exportsInputText: exportsInputText,
    exportsInputTextArea: exportsInputTextArea,
    exportsDateInput: exportsDateInput,
    paragraphBody: paragraphBody,
    tariffExpander: tariffExpander,
    saveButtons: saveButtons,
    link: link,
    additionalDocument: AdditionalDocHelper,
    appConfig: AppConfig
)

@(mode: Mode, itemId: String, form: Form[AdditionalDocument])(implicit request: JourneyRequest[_], messages: Messages)

@guidance = @{ appConfig.guidance }

@measurementInput(field: Field, labelKey: String, inputClasses: String) = {
    @govukInput(Input(
        id = field.id,
        name = field.name,
        value = field.value,
        label = Label(content = Text(messages(labelKey)), classes = "govuk-label"),
        classes = s"$inputClasses ${if(field.hasErrors) "govuk-input--error"}"
    ))
}

@measurementUnitField = @{form(s"$documentWriteOffKey.$measurementUnitKey")}
@qualifierField = @{form(s"$documentWriteOffKey.$qualifierKey")}
@measurementErrors = @{measurementUnitField.errors ++ qualifierField.errors}

@measurementUnitAndQualifierContent = {

    <p class="govuk-body" id="documentWriteOff-text">
        @Html(messages("declaration.additionalDocument.measurementUnit.text",
            link(
                text = messages("declaration.additionalDocument.measurementUnit.link.text"),
                call = Call("GET", appConfig.additionalDocumentsUnitCodes),
                target = "_blank"
            )
        ))
    </p>

    <span class="govuk-hint" id="documentWriteOff-hint">
        @Html(messages("declaration.additionalDocument.measurementUnit.hint"))
    </span>

    @if(measurementErrors.nonEmpty){
        <span class="govuk-error-message">
            <span class="govuk-visually-hidden">@messages("site.accessibility.error")</span>
            @Html(measurementErrors.map(err => messages(err.message, err.args:_*)).mkString("<br>"))
        </span>
    }

    <div class="govuk-date-input">
        <div class="govuk-date-input__item">
        @measurementInput(
            field = measurementUnitField,
            labelKey = "declaration.additionalDocument.measurementUnit",
            inputClasses = "govuk-input--width-4"
        )
        </div>
        <div class="govuk-date-input__item">
        @measurementInput(
            field = qualifierField,
            labelKey = "declaration.additionalDocument.qualifier",
            inputClasses = "govuk-input--width-2"
        )
        </div>
    </div>
}

@measurementUnitAndQualifier = {
      <div class="govuk-form-group @if(measurementErrors.nonEmpty){govuk-form-group--error}">

          @govukFieldset(Fieldset(
              legend = Some(Legend(
                  content = Text(messages("declaration.additionalDocument.measurementUnit.header")),
                  classes = "govuk-fieldset__legend--m"
              )),
              attributes = Map("id" -> "measurementUnitAndQualifier"),
              html = HtmlFormat.fill(List(measurementUnitAndQualifierContent))
          ))
      </div>
}

@expander1Content = {
    @commodityCodeOfItem(itemId).fold {
        @paragraphBody(messages("declaration.additionalDocument.expander.paragraph1.withoutCommodityCode.text",
            link(
                text = messages("declaration.additionalDocument.expander.paragraph1.withoutCommodityCode.link1.text"),
                call = Call("GET", appConfig.tradeTariffSections),
                target = "_blank"
            )
        ))
    } { commodityCode =>
        @paragraphBody(messages("declaration.additionalDocument.expander.paragraph1.withCommodityCode.text",
            link(
                text = messages("declaration.additionalDocument.expander.paragraph1.withCommodityCode.link1.text", commodityCode.codeAsShown),
                call = Call("GET", appConfig.commodityCodeTariffPageUrl.replace(CommodityDetails.placeholder, commodityCode.codeAsRef)),
                target = "_blank"
            )
        ))
    }

    @paragraphBody(messages("declaration.additionalDocument.expander.paragraph2.text"))

    @paragraphBody(messages("declaration.additionalDocument.expander.paragraph3.text",
        link(
            text = messages("declaration.additionalDocument.expander.paragraph3.link1.text"),
            call = Call("GET", appConfig.additionalDocumentsLicenceTypes),
            target = "_blank"
        )
    ))

    @paragraphBody(messages("declaration.additionalDocument.expander.paragraph4.text",
        link(
            text = messages("declaration.additionalDocument.expander.paragraph4.link1.text"),
            call = Call("GET", guidance.commodityCode0306310010),
            target = "_blank"
        )
    ))
}

@expander2Content = {

    @paragraphBody(messages("declaration.additionalDocument.documentTypeCode.expander.paragraph1.text",
        link(
            text = messages("declaration.additionalDocument.documentTypeCode.expander.paragraph1.link1.text"),
            call = Call("GET", appConfig.additionalDocumentsUnionCodes),
            target = "_blank"
        )
    ))

    @paragraphBody(messages("declaration.additionalDocument.documentTypeCode.expander.paragraph2.text",
        link(
            text = messages("declaration.additionalDocument.documentTypeCode.expander.paragraph2.link1.text"),
            call = Call("GET", appConfig.additionalDocumentsReferenceCodes),
            target = "_blank"
        )
    ))

    @paragraphBody(messages("declaration.additionalDocument.documentTypeCode.expander.paragraph3.text"))
}


@pageFields = {
    @formGroupWrapper(field = form(AdditionalDocumentFormGroupId)){
        @exportsInputText(
            field = form(documentTypeCodeKey),
            labelKey = "declaration.additionalDocument.documentTypeCode",
            hintKey = Some(additionalDocument.documentCodeHint),
            inputClasses = Some("govuk-input--width-4"),
            bodyHtml = Some(paragraphBody(
                message = messages(additionalDocument.documentCodeText),
                id = Some(s"$documentTypeCodeKey-text")
            ))
        )
        @govukDetails(Details(
            summary = Text(messages("declaration.additionalDocument.documentTypeCode.expander.title")),
            content = HtmlContent(expander2Content),
            id = Some("documentTypeCode-expander"))
        )
        @exportsInputText(
            field = form(documentIdentifierKey),
            labelKey = "declaration.additionalDocument.documentIdentifier",
            inputClasses = Some("govuk-input--width-30"),
            bodyHtml = Some(paragraphBody(
                message = messages("declaration.additionalDocument.documentIdentifier.body"),
                id = Some(s"$documentIdentifierKey-text")
            ))
        )
        @{
            additionalDocument.documentIdentifierInsets
        }
        @exportsInputText(
            field = form(documentStatusKey),
            labelKey = "declaration.additionalDocument.documentStatus",
            inputClasses = Some("govuk-input--width-2"),
            bodyHtml = Some(paragraphBody(
                message = messages("declaration.additionalDocument.documentStatus.text"),
                id = Some(s"$documentStatusKey-text")
            ))
        )
        @exportsInputText(
            field = form(documentStatusReasonKey),
            labelKey = "declaration.additionalDocument.documentStatusReason",
            hintKey = Some("declaration.additionalDocument.documentStatusReason.hint"),
            inputClasses = Some("govuk-input--width-30"),
            bodyHtml = Some(paragraphBody(
                message = messages("declaration.additionalDocument.documentStatusReason.text"),
                id = Some(s"$documentStatusReasonKey-text")
            ))
        )
        @exportsInputTextArea(
            field = form(issuingAuthorityNameKey),
            labelKey = "declaration.additionalDocument.issuingAuthorityName",
            inputClasses = Some("govuk-input--width-20"),
            bodyHtml = Some(paragraphBody(
                message = messages("declaration.additionalDocument.issuingAuthorityName.text"),
                id = Some(s"$issuingAuthorityNameKey-text")
            ))
        )
        @exportsDateInput(
            fieldName = dateOfValidityKey,
            form = form,
            hintKey = Some("declaration.additionalDocument.dateOfValidity.hint"),
            labelKey = "declaration.additionalDocument.dateOfValidity"
        )
        @measurementUnitAndQualifier
        @exportsInputText(
            field = form(s"$documentWriteOffKey.$documentQuantityKey"),
            labelKey = "declaration.additionalDocument.documentQuantity",
            labelClasses = "govuk-label--m",
            hintKey = Some("declaration.additionalDocument.documentQuantity.hint"),
            inputClasses = Some("govuk-input--width-20")
        )
    }
}

@errorSummary(form.errors)

@sectionHeader(messages("declaration.section.5"))

    @govukFieldset(Fieldset(
        legend = Some(Legend(
            content = Text(messages(AdditionalDocHelper.title)),
            classes = gdsPageLegend,
            isPageHeading = true
        )),
        html = HtmlFormat.fill(List(
            additionalDocument.pageBody,
            govukDetails(Details(
                summary = Text(messages("declaration.additionalDocument.expander.title")),
                content = HtmlContent(expander1Content),
                id = Some("top-expander"))),
            pageFields,
            tariffExpander(AdditionalDocument, request.declarationType)(messages, appConfig),
            saveButtons()
        ))
    ))