@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import controllers.declaration.routes._
@import controllers.navigation.{Navigator, ItemId}
@import models.requests.JourneyRequest
@import forms.declaration.additionaldocuments.DocumentWriteOff._
@import forms.declaration.additionaldocuments.DocumentsProduced
@import forms.declaration.additionaldocuments.DocumentsProduced._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.{BackButton, Title}
@import views.html.components.gds._
@import views.components.gds.Styles._
@import play.twirl.api.HtmlFormat
@import scala.collection.immutable

@this(govukLayout: gdsMainTemplate,
        govukFieldset: GovukFieldset,
        govukTable : GovukTable,
        govukInput: GovukInput,
        addButton: addButton,
        removeButton: removeButton,
        errorSummary: errorSummary,
        sectionHeader: sectionHeader,
        exportsInputText: exportsInputText,
        exportsInputTextArea: exportsInputTextArea,
        exportsDateInput: exportsDateInput,
        tariffDetails: tariffDetails,
        saveButtons: saveButtons,
        formHelper: uk.gov.hmrc.play.views.html.helpers.FormWithCSRF)

@(mode: Mode, itemId: String, form: Form[DocumentsProduced], documents: Seq[DocumentsProduced])(implicit request: JourneyRequest[_], messages: Messages)

@tariffBodyDesc = { @Html(messages("declaration.type.consignmentTariffText", components.details_content_link())) }

@tariffBody = { @components.tariff_body_partial(messages("declaration.type.documentProcudedListItemOne"), messages("declaration.type.documentProcudedListItemTwo"))(tariffBodyDesc)}

@documentsTable = {
    @if(documents.nonEmpty) {
    @govukTable(Table(
        attributes = Map("id" -> "documents_produced"),
        rows = documents.zipWithIndex.map{ case(document, index) =>
            Seq(
                TableRow(
                    content = Text(document.documentTypeCode.getOrElse("")),
                    attributes = Map("id" -> s"documents_produced-row$index-code")
                ),
                TableRow(
                    content = Text(document.documentIdentifier.getOrElse("")),
                    attributes = Map("id" -> s"documents_produced-row$index-identifier")
                ),
                TableRow(
                    content = HtmlContent(removeButton(value = Some(document.toJson.toString), hiddenLabel = Some(messages("supplementary.addDocument.remove.hint", document.documentIdentifier.getOrElse(""))))),
                    attributes = Map("id" -> s"documents_produced-row$index-remove_button")
                )
            )
        },
        head = Some(List(
            HeadCell(
                content = Text(messages("supplementary.addDocument.summary.documentTypeCode"))
            ),
            HeadCell(
                content = Text(messages("supplementary.addDocument.summary.documentIdentifier")),
                colspan = Some(2)
            )
        ))
    ))
}
}

@measurementInput(field: Field, labelKey: String, inputClasses: String) = {
    @govukInput(Input(
        id = field.id,
        name = field.name,
        value = field.value,
        label = Label(content = Text(messages(labelKey)), classes = "govuk-label"),
        classes = s"$inputClasses ${if(field.hasErrors) "govuk-input--error"}"
    ))
}

@measurementUnitField = @{form(s"$documentWriteOffKey.$measurementUnitKey")}
@qualifierField = @{form(s"$documentWriteOffKey.$qualifierKey")}
@measurementErrors = @{measurementUnitField.errors ++ qualifierField.errors}

@measurementUnitAndQualifierContent = {

    <span class="govuk-hint">
        @Html(messages("supplementary.addDocument.measurementUnit.hint"))
    </span>

    @measurementErrors.map { error =>
        <span class="govuk-error-message">
            <span class="govuk-visually-hidden">@messages("site.accessibility.error")</span>
            @messages(error.message, error.args: _*)
        </span>
    }

    <div class="govuk-date-input">
        <div class="govuk-date-input__item">
        @measurementInput(
            field = measurementUnitField,
            labelKey = "supplementary.addDocument.measurementUnit",
            inputClasses = "govuk-input--width-4"
        )
        </div>
        <div class="govuk-date-input__item">
        @measurementInput(
            field = qualifierField,
            labelKey = "supplementary.addDocument.qualifier",
            inputClasses = "govuk-input--width-2"
        )
        </div>
    </div>
}

@measurementUnitAndQualifier = {
      <div class="govuk-form-group @if(measurementErrors.nonEmpty){govuk-form-group--error}">

          @govukFieldset(Fieldset(
              legend = Some(Legend(
                  content = Text(messages("supplementary.addDocument.measurementUnit.header")),
                  classes = "govuk-fieldset__legend--m"
              )),
              attributes = Map("id" -> "measurementUnitAndQualifier"),
              html = HtmlFormat.fill(immutable.Seq(
                  measurementUnitAndQualifierContent
              )
              )))
      </div>
}

@govukLayout(
    title = Title("supplementary.addDocument.title", "supplementary.summary.yourReferences.header"),
    backButton = Some(BackButton(messages("site.back"), Navigator.backLink(DocumentsProduced, mode, ItemId(itemId))))) {

    @formHelper(action = DocumentsProducedController.saveForm(mode, itemId), 'autoComplete -> "off") {

        @errorSummary(form.errors)

        @sectionHeader(messages("supplementary.summary.yourReferences.header"))

        @govukFieldset(Fieldset(
            legend = Some(Legend(
                content = Text(messages("supplementary.addDocument.title")),
                classes = gdsPageLegend,
                isPageHeading = true
            )),
            html = HtmlFormat.fill(immutable.Seq(
                documentsTable,
                exportsInputText(
                    field = form(documentTypeCodeKey),
                    labelKey = "supplementary.addDocument.documentTypeCode",
                    hintKey = Some("supplementary.addDocument.documentTypeCode.hint"),
                    inputClasses = Some("govuk-input--width-4")
                ),
                exportsInputText(
                    field = form(documentIdentifierKey),
                    labelKey = "supplementary.addDocument.documentIdentifier",
                    hintKey = Some("supplementary.addDocument.documentIdentifier.hint"),
                    inputClasses = Some("govuk-input--width-30")
                ),
                exportsInputText(
                    field = form(documentStatusKey),
                    labelKey = "supplementary.addDocument.documentStatus",
                    hintKey = Some("supplementary.addDocument.documentStatus.hint"),
                    inputClasses = Some("govuk-input--width-2")
                ),
                exportsInputText(
                    field = form(documentStatusReasonKey),
                    labelKey = "supplementary.addDocument.documentStatusReason",
                    hintKey = Some("supplementary.addDocument.documentStatusReason.hint"),
                    inputClasses = Some("govuk-input--width-30")
                ),
                exportsInputTextArea(
                    field = form(issuingAuthorityNameKey),
                    labelKey = "supplementary.addDocument.issuingAuthorityName",
                    hintKey = Some("supplementary.addDocument.issuingAuthorityName.hint"),
                    inputClasses = Some("govuk-input--width-20")
                ),
                exportsDateInput(
                    fieldName = dateOfValidityKey,
                    form = form,
                    labelKey = "supplementary.addDocument.dateOfValidity",
                    hintKey = Some("supplementary.addDocument.dateOfValidity.hint")
                ),
                measurementUnitAndQualifier,
                exportsInputText(
                    field = form(s"$documentWriteOffKey.$documentQuantityKey"),
                    labelKey = "supplementary.addDocument.documentQuantity",
                    hintKey = Some("supplementary.addDocument.documentQuantity.hint"),
                    inputClasses = Some("govuk-input--width-20")
                ),
                tariffDetails(messages("site.details.summary_text_this"), HtmlContent(tariffBody)),
                addButton(hiddenLabel = Some(messages("supplementary.addDocument.add.hint"))),
                saveButtons()
            ))
        ))

    }
}
